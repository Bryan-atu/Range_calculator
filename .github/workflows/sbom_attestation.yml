name: Evaluation - SBOM Attestation Integrity (5.2.5)

on:
  push:
    branches:
      - feat/Range-9
  pull_request:

permissions:
  id-token: write
  contents: read

jobs:
  sbom-attestation-eval:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y gcc make curl jq

      - name: Compile code
        run: gcc range_calculator.c test_range_calculator.c -o range_test -Wall -Wextra

      - name: Install Cosign
        run: |
          set -euo pipefail
          curl -LO https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64
          chmod +x cosign-linux-amd64
          sudo mv cosign-linux-amd64 /usr/local/bin/cosign
          cosign version

      - name: Install rekor-cli
        run: |
          set -euo pipefail
          curl -sSfL https://github.com/sigstore/rekor/releases/latest/download/rekor-cli-linux-amd64 -o rekor-cli
          chmod +x rekor-cli
          sudo mv rekor-cli /usr/local/bin/rekor-cli
          rekor-cli version

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0
        with:
          path: ./
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Create SBOM attestation (predicate -> range_test)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail
          cosign attest-blob --yes \
            --predicate sbom.spdx.json \
            --type spdxjson \
            range_test

      - name: Create results CSV
        run: |
          echo "trial,verify_success,rekor_present,latency_ms,rekor_uuid,error_snippet" > sbom_attestation_metrics.csv

      - name: Run attestation verification trials (latency + Rekor)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail

          N=20

          verify_attestation() {
            # Verify attestation (keyless policy pinned)
            cosign verify-attestation-blob "$1" \
              --type "spdxjson" \
              --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
              --certificate-identity-regexp "^https://github.com/${GITHUB_REPOSITORY}/" \
              --rekor-url "https://rekor.sigstore.dev"
          }

          for trial in $(seq 1 $N); do
            start=$(date +%s%3N)

            set +e
            OUT=$(verify_attestation "range_test" 2>&1)
            RC=$?
            set -e

            end=$(date +%s%3N)
            LAT=$((end - start))

            if [ $RC -eq 0 ]; then
              VS=1
              ERR="OK"
            else
              VS=0
              ERR=$(echo "$OUT" | head -n 1 | tr ',' ';')
            fi

            # Rekor presence check: search by artifact hash (best-effort)
            SHA=$(sha256sum range_test | awk '{print $1}')
            REKOR_UUID=$(rekor-cli search --sha "$SHA" --rekor_server https://rekor.sigstore.dev 2>/dev/null | head -n 1 || true)

            if [ -n "${REKOR_UUID}" ] && [ "${REKOR_UUID}" != "null" ]; then
              RP=1
            else
              RP=0
              REKOR_UUID=""
            fi

            echo "${trial},${VS},${RP},${LAT},${REKOR_UUID},${ERR}" >> sbom_attestation_metrics.csv
          done

          echo "Preview:"
          head -n 10 sbom_attestation_metrics.csv

      - name: Upload results CSV
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom-attestation-metrics
          path: sbom_attestation_metrics.csv

      - name: Upload SBOM predicate (for audit evidence)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom-predicate
          path: sbom.spdx.json
