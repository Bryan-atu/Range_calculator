name: Evaluation - SBOM attestation integrity (5.2.5)

on:
  push:
    branches:
      - feat/Range-9
  pull_request:

permissions:
  id-token: write
  contents: read

jobs:
  sbom-attestation-eval:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y gcc make curl jq

      - name: Compile code
        run: gcc range_calculator.c test_range_calculator.c -o range_test -Wall -Wextra

      - name: Install Cosign
        run: |
          set -euo pipefail
          curl -LO https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64
          chmod +x cosign-linux-amd64
          sudo mv cosign-linux-amd64 /usr/local/bin/cosign
          cosign version

      - name: Install rekor-cli
        run: |
          set -euo pipefail
          curl -sSfL https://github.com/sigstore/rekor/releases/latest/download/rekor-cli-linux-amd64 -o rekor-cli
          chmod +x rekor-cli
          sudo mv rekor-cli /usr/local/bin/rekor-cli
          rekor-cli version

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0
        with:
          path: ./
          format: spdx-json
          output-file: sbom.spdx.json

      # sign the blob so we have a complete chain (not strictly required for attestation)
      - name: Sign executable with cosign (OIDC bundle)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail
          cosign sign-blob --yes --bundle range_test.sigstore.json range_test

      # Create an explicit/downloadable bundle for the attestation itself
      - name: Create SBOM attestation bundle (predicate -> range_test)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail
          cosign attest-blob --yes \
            --predicate sbom.spdx.json \
            --type spdxjson \
            --bundle sbom_attestation.sigstore.json \
            range_test

      - name: Create results CSV
        run: |
          echo "run,attestation_verified,rekor_entry_present,verification_latency_ms,rekor_uuid,failure_reason" > sbom_attestation_metrics.csv

      - name: Run attestation verification trials (N runs)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail

          N=20

          verify_attestation() {
            # Verify the blob attestation against the attestation bundle (keyless mode)
            cosign verify-blob-attestation "$1" \
              --bundle "$2" \
              --type "spdxjson" \
              --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
              --certificate-identity-regexp "^https://github.com/${GITHUB_REPOSITORY}/" \
              --rekor-url "https://rekor.sigstore.dev"
          }

          for run in $(seq 1 $N); do
            start=$(date +%s%3N)

            set +e
            OUT=$(verify_attestation "range_test" "sbom_attestation.sigstore.json" 2>&1)
            RC=$?
            set -e

            end=$(date +%s%3N)
            LAT=$((end - start))

            SHA=$(sha256sum range_test | awk '{print $1}')
            REKOR_UUID=$(rekor-cli search --sha "$SHA" --rekor_server https://rekor.sigstore.dev 2>/dev/null | head -n 1 || true)

            if [ -n "${REKOR_UUID}" ] && [ "${REKOR_UUID}" != "null" ]; then
              RP=1
            else
              RP=0
              REKOR_UUID=""
            fi

            if [ $RC -eq 0 ]; then
              echo "${run},1,${RP},${LAT},${REKOR_UUID},OK" >> sbom_attestation_metrics.csv
            else
              ERR=$(echo "$OUT" | head -n 1 | tr ',' ';')
              echo "${run},0,${RP},${LAT},${REKOR_UUID},${ERR}" >> sbom_attestation_metrics.csv
            fi
          done

          echo "Preview:"
          head -n 15 sbom_attestation_metrics.csv

      - name: Upload results CSV
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom-attestation-metrics
          path: sbom_attestation_metrics.csv

      - name: Upload attestation and SBOM evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom-attestation-evidence
          path: |
            range_test
            range_test.sigstore.json
            sbom.spdx.json
            sbom_attestation.sigstore.json
